name: Render and Upload Image

on:
  repository_dispatch:
    types: [render_and_upload, render_and_upload_reddit_chain]

jobs:
  render-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-python-3.11-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-python-3.11-pip-

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Render image and Upload
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_SECRET: ${{ secrets.REDDIT_SECRET }}
          # The payload is now at github.event.client_payload.render_payload
          # We use toJSON() to convert the JSON object to a string for the env var
          RENDER_PAYLOAD_JSON: ${{ toJSON(github.event.client_payload.render_payload) }}
        run: |
          # Trim whitespace from API key
          export ALLTHEPICS_API_KEY=$(echo "${{ secrets.ALLTHEPICS_API_KEY }}" | xargs)
          # The command is github.event.action (the event_type from the dispatch)
          # The UID is in the client_payload
          python renderer.py ${{ github.event.action }} ${{ github.event.client_payload.uid }}